<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSC Exam Prep - Gamified</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ffffff;
            --dark-color: #2c3e50;
            --bg-color: #34495e;
            --font-family: 'Poppins', sans-serif;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #1d2b64, #f8cdda);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
        }

        #playerPFP {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin: 10px auto -15px;
            object-fit: cover;
        }

        .player-stats {
            margin-top: 15px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }
        .player-stats p { margin-bottom: 5px; font-weight: 600; }
        .xp-bar {
            width: 100%;
            height: 10px;
            background-color: rgba(255,255,255,0.3);
            border-radius: 5px;
            overflow: hidden;
        }
        .xp-bar-fill {
            height: 100%;
            background-color: var(--warning-color);
            width: 0%;
            transition: width 0.5s ease-in-out;
            border-radius: 5px;
        }

        nav {
            display: flex;
            background: var(--dark-color);
            flex-wrap: wrap;
            justify-content: center;
        }
        nav button {
            background: none;
            border: none;
            color: var(--light-color);
            padding: 15px 20px;
            cursor: pointer;
            font-size: 14px;
            font-family: var(--font-family);
            transition: all 0.3s;
            font-weight: 600;
        }
        nav button:hover {
            background: rgba(255,255,255,0.1);
        }
        nav button.active {
            background: var(--primary-color);
            color: white;
        }
        
        .tab-content { display: none; padding: 30px; min-height: 400px; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group { margin-bottom: 20px; }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            margin-top: 5px;
            transition: all 0.3s;
            font-family: var(--font-family);
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(142, 68, 173, 0.3);
            outline: none;
        }

        button {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 5px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        button:active {
            transform: translateY(-1px) scale(0.98);
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success { background: linear-gradient(135deg, var(--success-color), #27ae60); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #c0392b); }
        
        .timer {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 20px 0;
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            padding: 15px;
            border-radius: var(--border-radius);
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .option {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #eee;
            margin: 10px 0;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .option:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }
        
        .option.correct {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border-color: #27ae60;
            transform: scale(1.03);
            animation: pulse 0.5s;
        }
        
        .option.wrong {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border-color: #c0392b;
            animation: shake 0.5s;
        }
        
        @keyframes pulse {
            0% { transform: scale(1.03); }
            50% { transform: scale(1.06); }
            100% { transform: scale(1.03); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .score {
            text-align: center; font-size: 24px; margin: 20px 0; padding: 15px;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white; border-radius: var(--border-radius);
        }
        
        .leaderboard-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px; text-align: left; border-bottom: 1px solid #ddd;
        }
        .leaderboard-table th { background-color: #f2f2f2; font-weight: bold; }
        .leaderboard-table tr:hover { background-color: #f5f5f5; }
        .leaderboard-table .winner { background-color: #f1c40f; color: white; font-weight: bold; }
        .history-item, .question-set { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: var(--border-radius); border-left: 4px solid var(--secondary-color);}
        .wrong-answer { color: var(--danger-color); font-weight: bold; }
        .correct-answer { color: var(--success-color); font-weight: bold; }

        .hidden { display: none; }

        .pfp-upload-btn {
            background: var(--warning-color);
            color: white;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: inline-block;
            text-align: center;
            margin: 5px;
            transition: background 0.3s;
        }
        .pfp-upload-btn:hover {
            background: #d35400;
        }

        /* Custom Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 30px; border: 1px solid #888;
            width: 90%; max-width: 500px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); text-align: center; animation: slideIn 0.5s;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        #confetti-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1001; pointer-events: none;
        }

        .dashboard-card {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
        }

        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white;
            padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 999;
        }
        .firebase-status.online::before { content: '●'; color: var(--success-color); margin-right: 5px; }
        .firebase-status.offline::before { content: '●'; color: var(--danger-color); margin-right: 5px; }

    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>
    <div class="container">
        <header>
            <h1>PSC Exam Prep</h1>
            <p>Level Up Your Knowledge</p>
            <img id="playerPFP" src="https://placehold.co/80x80/FFFFFF/333333?text=PFP" alt="Profile Picture" class="hidden">
            <div id="playerStats" class="player-stats hidden">
                <p id="playerNameDisplay"></p>
                <p>Level <span id="playerLevel">1</span> (<span id="playerXP">0</span> / <span id="xpToNextLevel">100</span> XP)</p>
                <div class="xp-bar">
                    <div id="xpBarFill" class="xp-bar-fill"></div>
                </div>
            </div>
        </header>

        <nav id="tab-nav">
            <button onclick="switchTab('practice')" class="active">Practice & Dashboard</button>
            <button onclick="switchTab('revision')">Revision Plan</button>
            <button onclick="switchTab('leaderboard')">Leaderboard</button>
            <button onclick="switchTab('history')">My History</button>
            <button onclick="switchTab('settings')">Settings</button>
        </nav>
        
        <main>
            <div id="practice" class="tab-content active">
                <h2>Welcome!</h2>
                <div class="dashboard-card">
                    <h3 id="welcomeMessage">Select or create a player to begin!</h3>
                    <p id="motivationalQuote" style="margin-top:10px; font-style: italic;"></p>
                </div>
                <div class="player-selector">
                    <select id="playerSelect" onchange="setPlayerName()" class="styled-select" style="margin-bottom:10px;"></select>
                    <input type="text" id="newPlayerName" placeholder="Or enter new name" class="styled-input">
                    <button onclick="setPlayerName(true)">Set Name</button>
                    <label for="pfpUpload" class="pfp-upload-btn">Upload PFP</label>
                    <input type="file" id="pfpUpload" accept="image/*" class="hidden">
                </div>

                <hr style="margin: 20px 0;">

                <h2>Practice Mode</h2>
                <div class="form-group">
                    <label>Select Question Set:</label>
                    <select id="practiceSetSelect" class="styled-select"></select>
                    <button onclick="startPractice()" id="startPracticeBtn" disabled>Start Practice</button>
                </div>
                <div id="practiceArea" class="hidden">
                    <div class="timer" id="practiceTimer">Time: 0s</div>
                    <div id="practiceQuestion" style="font-size: 18px; margin: 20px 0; font-weight: bold;"></div>
                    <div id="practiceOptions"></div>
                    <div class="score" id="practiceScore">Score: 0</div>
                    <button onclick="endPractice()" class="btn-danger">End Practice</button>
                </div>
            </div>

            <div id="revision" class="tab-content">
                <h2>Today's Revision Schedule</h2>
                <div style="background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px;">
                    <h3>Spaced Repetition</h3>
                    <p>Sets due for revision today based on their upload date will appear below.</p>
                </div>
                <div id="todaysRevisionList">
                    </div>
            </div>

            <div id="leaderboard" class="tab-content">
                <h2>Leaderboard</h2>
                <div class="set-filter">
                    <label>Filter by Question Set:</label>
                    <select id="leaderboardSetFilter" onchange="showLeaderboard()" class="styled-select"></select>
                </div>
                <table class="leaderboard-table">
                    <thead><tr><th>Rank</th><th>Player</th><th>Set</th><th>Score</th><th>%</th><th>Date</th></tr></thead>
                    <tbody id="leaderboardTableBody"></tbody>
                </table>
                 <button onclick="resetLeaderboard()" class="btn-danger">Reset Leaderboard</button>
            </div>

            <div id="history" class="tab-content">
                <h2>My Practice History</h2>
                <div class="player-selector">
                    <select id="historyPlayerSelect" onchange="loadHistory()" class="styled-select"></select>
                </div>
                <div id="historyList"></div>
            </div>

            <div id="settings" class="tab-content">
                <div id="mainSettings">
                    <h2>Settings</h2>
                    <h3>Firebase Configuration</h3>
                    <div class="form-group">
                        <label>Firebase Configuration JSON:</label>
                        <textarea id="firebaseConfig" rows="8"></textarea>
                        <button onclick="saveFirebaseConfig()" class="btn-success">Save Config</button>
                        <button onclick="resetFirebaseConfig()" class="btn-danger">Reset Config</button>
                    </div>
                    <h3>Firebase Status: <span id="firebaseStatus">Not Connected</span></h3>
                    <button onclick="testFirebaseConnection()">Test Connection</button>
                    <hr style="margin: 20px 0;">
                    <h3>Data Management</h3>
                    <button onclick="syncToFirebase()" class="btn-success">Sync to Firebase</button>
                    <button onclick="loadFromFirebase()">Load from Firebase</button>
                    <button onclick="exportData()">Export Data</button>
                    <button onclick="importData()">Import Data</button>
                    <button onclick="clearAllData()" class="btn-danger">Clear All Data</button>
                    <hr style="margin: 20px 0;">
                    <h3>Admin Actions</h3>
                    <button id="showAddQuestionsBtn">Manage Question Sets</button>
                </div>

                <div id="addQuestionsSection" class="hidden" style="margin-top: 20px;">
                    <button id="backToSettingsBtn">&larr; Back to Settings</button>
                    <h2>Add Questions</h2>
                    <div id="addQuestionsContent">
                        <div class="form-group">
                            <label>Question Set Name:</label>
                            <input type="text" id="setName" placeholder="e.g., General Knowledge Set 1">
                        </div>
                        <div class="form-group">
                            <label>Question:</label>
                            <textarea id="questionText" placeholder="Enter your question here..." rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Options (one per line):</label>
                            <textarea id="questionOptions" placeholder="Option A&#10;Option B&#10;Option C&#10;Option D" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Correct Answer:</label>
                            <select id="correctAnswer">
                                <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option>
                            </select>
                        </div>
                        <button onclick="addQuestion()">Add Question</button>
                        <hr style="margin: 20px 0;">
                        <h3>Bulk Import</h3>
                        <div class="form-group">
                            <label>Paste questions (Format: Question | Opt1 | Opt2 | Opt3 | Opt4 | CorrectLetter):</label>
                            <textarea id="bulkQuestions" rows="6"></textarea>
                        </div>
                        <input type="text" id="bulkSetName" placeholder="Enter Question Set Name for Bulk Import" />
                        <button onclick="importBulkQuestions()">Import Questions</button>
                        <div id="savedSets" style="margin-top: 30px;">
                            <h3>Your Question Sets</h3>
                            <div id="setsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="resultsModal" class="modal"><div class="modal-content"><h2 id="modalTitle"></h2><p id="modalScore"></p><p id="modalTime"></p><p id="modalXPGained"></p><button onclick="closeModal('resultsModal')">Close</button></div></div>
    <div id="passwordModal" class="modal"><div class="modal-content"><h3 id="passwordModalTitle"></h3><p id="passwordModalPrompt"></p><input type="password" id="passwordInput"><button id="passwordSubmitBtn"></button><button onclick="closeModal('passwordModal')" class="btn-danger">Cancel</button></div></div>
    <div id="viewDetailsModal" class="modal"><div class="modal-content" id="viewDetailsModalContent" style="text-align: left; max-height: 80vh; overflow-y: auto;"></div></div>

    <div id="firebaseStatusIndicator" class="firebase-status offline">Firebase: Not Connected</div>

    <script>
        // --- GAMIFICATION & UI ---
        let xp = 0, level = 1, xpToNextLevel = 100;
        const XP_PER_CORRECT_ANSWER = 10;
        const quotes = ["The secret to getting ahead is getting started.", "Believe you can and you're halfway there.", "Success is the sum of small efforts, repeated day in and day out."];
        let audioCtx;

        // --- APP LOGIC ---
        let firebaseConfig = JSON.parse(localStorage.getItem('firebaseConfig')) || null;
        let db = null;
        let isFirebaseConnected = false;
        
        let questionSets = JSON.parse(localStorage.getItem('pscQuestionSets')) || {};
        let practiceHistory = JSON.parse(localStorage.getItem('pscPracticeHistory')) || {};
        let revisionProgress = JSON.parse(localStorage.getItem('pscRevisionProgress')) || {};
        
        const ADMIN_PASSWORD = "admin123", SETTINGS_PASSWORD = "2525";
        let isAdmin = false;
        
        let currentSet = [], currentQuestionIndex = 0, score = 0, timer, timeElapsed = 0, currentPlayerName = '', currentAttempt = null;

        document.addEventListener('DOMContentLoaded', init);

        function init() {
            initializeFirebase();
            loadQuestionSets();
            updateSetSelects();
            updatePlayerSelects();
            document.getElementById('motivationalQuote').textContent = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('pfpUpload').addEventListener('change', handlePFPUpload);
            // MODIFICATION: Remove password logic for "Manage Question Sets" button
            document.getElementById('showAddQuestionsBtn').addEventListener('click', showAddQuestionsSection); 
            document.getElementById('backToSettingsBtn').addEventListener('click', () => {
                document.getElementById('addQuestionsSection').classList.add('hidden');
                document.getElementById('mainSettings').classList.remove('hidden');
            });
        }
        
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

        // --- FIREBASE FUNCTIONS ---
        function initializeFirebase() {
            if (!firebaseConfig) {
                firebaseConfig = {
                    apiKey: "AIzaSyCF7gt8mnbQ1wWCb1wl_mHlmNh02Ssff8g",
                    authDomain: "new-psc.firebaseapp.com",
                    databaseURL: "https://new-psc-default-rtdb.firebaseio.com",
                    projectId: "new-psc",
                    storageBucket: "new-psc.appspot.com",
                    messagingSenderId: "189806791539",
                    appId: "1:189806791539:web:2c5ec45561e6822d93d306"
                };
                localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));
            }
            document.getElementById('firebaseConfig').value = JSON.stringify(firebaseConfig, null, 2);
            
            try {
                if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                updateFirebaseStatus('Connecting...', false);
                
                db.ref('.info/connected').on('value', snapshot => {
                    if (snapshot.val() === true) {
                        updateFirebaseStatus('Connected', true);
                        isFirebaseConnected = true;
                        setupFirebaseListeners();
                        loadFromFirebase();
                    } else {
                        updateFirebaseStatus('Disconnected', false);
                        isFirebaseConnected = false;
                    }
                });
            } catch (error) {
                console.error('Firebase Init Error:', error);
                updateFirebaseStatus('Init Failed', false);
            }
        }

        function updateFirebaseStatus(status, isConnected) {
            const statusEl = document.getElementById('firebaseStatus');
            const indicatorEl = document.getElementById('firebaseStatusIndicator');
            statusEl.textContent = status;
            indicatorEl.textContent = `Firebase: ${status}`;
            indicatorEl.className = `firebase-status ${isConnected ? 'online' : 'offline'}`;
        }

        function setupFirebaseListeners() {
            if (!db) return;
            db.ref('questionSets').on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    questionSets = data;
                    localStorage.setItem('pscQuestionSets', JSON.stringify(questionSets));
                    loadQuestionSets();
                    updateSetSelects();
                }
            });
            db.ref('practiceHistory').on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    practiceHistory = data;
                    localStorage.setItem('pscPracticeHistory', JSON.stringify(practiceHistory));
                    updatePlayerSelects();
                    if (document.getElementById('leaderboard').classList.contains('active')) showLeaderboard();
                }
            });
        }
        
        function saveFirebaseConfig() {
            try {
                const config = JSON.parse(document.getElementById('firebaseConfig').value);
                firebaseConfig = config;
                localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));
                showNotification('Config saved. Reloading...');
                setTimeout(() => window.location.reload(), 1500);
            } catch (e) { showNotification('Invalid JSON format', 'error'); }
        }

        function resetFirebaseConfig() {
            localStorage.removeItem('firebaseConfig');
            document.getElementById('firebaseConfig').value = '';
            showNotification('Config reset. Reloading...');
            setTimeout(() => window.location.reload(), 1500);
        }
        
        function testFirebaseConnection() {
            if (!db) { showNotification('Firebase not initialized', 'error'); return; }
            db.ref('testConnection').set({ timestamp: Date.now() })
              .then(() => showNotification('Firebase connection test successful!'))
              .catch(err => showNotification(`Connection test failed: ${err.message}`, 'error'));
        }
        
        function syncToFirebase() {
            if (!isFirebaseConnected) { showNotification('Firebase not connected', 'error'); return; }
            db.ref('questionSets').set(questionSets);
            db.ref('practiceHistory').set(practiceHistory);
            db.ref('revisionProgress').set(revisionProgress);
            showNotification('All data synced to Firebase!');
        }

        function loadFromFirebase() {
            if (!isFirebaseConnected) { showNotification('Firebase not connected', 'error'); return; }
            db.ref('/').once('value').then(snapshot => {
                const data = snapshot.val();
                if(data.questionSets) questionSets = data.questionSets;
                if(data.practiceHistory) practiceHistory = data.practiceHistory;
                if(data.revisionProgress) revisionProgress = data.revisionProgress;
                localStorage.setItem('pscQuestionSets', JSON.stringify(questionSets));
                localStorage.setItem('pscPracticeHistory', JSON.stringify(practiceHistory));
                localStorage.setItem('pscRevisionProgress', JSON.stringify(revisionProgress));
                loadQuestionSets();
                updateSetSelects();
                updatePlayerSelects();
                showNotification('Data loaded from Firebase!');
            });
        }
        
        // --- DATA MANAGEMENT ---
        function exportData() {
            const data = { questionSets, practiceHistory, revisionProgress };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'psc-prep-backup.json'; a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(data.questionSets) questionSets = data.questionSets;
                        if(data.practiceHistory) practiceHistory = data.practiceHistory;
                        if(data.revisionProgress) revisionProgress = data.revisionProgress;
                        localStorage.setItem('pscQuestionSets', JSON.stringify(questionSets));
                        localStorage.setItem('pscPracticeHistory', JSON.stringify(practiceHistory));
                        localStorage.setItem('pscRevisionProgress', JSON.stringify(revisionProgress));
                        init();
                        showNotification('Data imported successfully!');
                    } catch (err) { showNotification('Invalid import file', 'error'); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            showPasswordModal("Clear All Data?", ADMIN_PASSWORD, () => {
                practiceHistory = {};
                localStorage.setItem('pscPracticeHistory', JSON.stringify(practiceHistory));
                if (isFirebaseConnected) { db.ref('practiceHistory').remove(); }
                
                // Clear all data, including questions (requires ADMIN_PASSWORD check)
                questionSets = {}; revisionProgress = {};
                localStorage.removeItem('pscQuestionSets');
                localStorage.removeItem('pscRevisionProgress');
                if (isFirebaseConnected) { db.ref('questionSets').remove(); db.ref('revisionProgress').remove(); }
                
                init();
                showNotification('All data cleared!', 'error');
            }, "Enter Admin Password");
        }

        // --- GAMIFICATION & PFP FUNCTIONS ---
        function updateProgressUI() {
            if (!currentPlayerName) {
                document.getElementById('playerStats').classList.add('hidden');
                document.getElementById('playerPFP').classList.add('hidden');
                return;
            }
            document.getElementById('playerStats').classList.remove('hidden');
            document.getElementById('playerNameDisplay').textContent = `Player: ${currentPlayerName}`;
            document.getElementById('playerLevel').textContent = level;
            document.getElementById('playerXP').textContent = xp;
            document.getElementById('xpToNextLevel').textContent = xpToNextLevel;
            document.getElementById('xpBarFill').style.width = `${(xp / xpToNextLevel) * 100}%`;
        }
        
        function addXP(amount) {
            xp += amount;
            if (xp >= xpToNextLevel) {
                level++; xp -= xpToNextLevel; xpToNextLevel = Math.floor(xpToNextLevel * 1.5);
                playSound('levelup');
                showNotification(`🎉 Level Up! You are now Level ${level}!`);
            }
            savePlayerProgress();
            updateProgressUI();
        }

        function savePlayerProgress() {
            if (!currentPlayerName) return;
            localStorage.setItem(`pscPlayerProgress_${currentPlayerName}`, JSON.stringify({ level, xp, xpToNextLevel }));
        }

        function loadPlayerProgress() {
            if (!currentPlayerName) return;
            const progress = JSON.parse(localStorage.getItem(`pscPlayerProgress_${currentPlayerName}`));
            if (progress) { ({ level, xp, xpToNextLevel } = progress); } 
            else { level = 1; xp = 0; xpToNextLevel = 100; }
            updateProgressUI();

            const pfpDataUrl = localStorage.getItem(`pscPlayerPFP_${currentPlayerName}`);
            const pfpElement = document.getElementById('playerPFP');
            if (pfpDataUrl) {
                pfpElement.src = pfpDataUrl;
            } else {
                pfpElement.src = `https://placehold.co/80x80/FFFFFF/333333?text=${currentPlayerName.substring(0,2).toUpperCase()}`;
            }
            pfpElement.classList.remove('hidden');
        }

        function handlePFPUpload(event) {
            if (!currentPlayerName) {
                showNotification("Please select a player first.", "error");
                event.target.value = null; // Reset file input
                return;
            }
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const pfpDataUrl = e.target.result;
                    localStorage.setItem(`pscPlayerPFP_${currentPlayerName}`, pfpDataUrl);
                    document.getElementById('playerPFP').src = pfpDataUrl;
                    showNotification("Profile picture updated!");
                };
                reader.readAsDataURL(file);
            }
        }

        // --- CORE APP FUNCTIONS ---
        function switchTab(tabName) {
            document.querySelectorAll('#tab-nav button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#tab-nav button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            
            const openTab = () => {
                document.getElementById(tabName).classList.add('active');
                if(tabName === 'leaderboard') showLeaderboard();
                if(tabName === 'history') loadHistory();
                if(tabName === 'revision') renderRevisionPage();
                if(tabName === 'settings') {
                    document.getElementById('addQuestionsSection').classList.add('hidden');
                    document.getElementById('mainSettings').classList.remove('hidden');
                }
            };

            if (tabName === 'settings') {
                showPasswordModal("Enter Settings Password", SETTINGS_PASSWORD, openTab, "Settings Access");
            } else {
                openTab();
            }
        }

        // MODIFICATION: Removed password check
        function showAddQuestionsSection() {
            document.getElementById('addQuestionsSection').classList.remove('hidden');
            document.getElementById('mainSettings').classList.add('hidden');
        }
        
        function setPlayerName(isButtonClicked = false) {
            const select = document.getElementById('playerSelect'), input = document.getElementById('newPlayerName');
            let name = isButtonClicked ? (input.value.trim() || select.value) : select.value;
            if (name) {
                currentPlayerName = name;
                showNotification(`Welcome, ${currentPlayerName}!`);
                document.getElementById('welcomeMessage').textContent = `Let's get started, ${currentPlayerName}!`;
                if (!Array.from(select.options).some(o => o.value === name)) {
                    const newOpt = document.createElement('option');
                    newOpt.value = name;
                    newOpt.textContent = name;
                    select.appendChild(newOpt);
                }
                select.value = currentPlayerName; input.value = '';
                loadPlayerProgress();
            } else if(isButtonClicked) { showNotification('Please select or enter a player name.', 'error'); }
        }
        
        function startPractice() {
            initAudio();
            const setName = document.getElementById('practiceSetSelect').value;
            if (!setName || !currentPlayerName) { showNotification('Please select a player and a question set.', 'error'); return; }
            currentSet = [...(questionSets[setName].questions || [])].sort(() => Math.random() - 0.5);
            if (currentSet.length === 0) { showNotification('Selected set is empty.', 'error'); return; }
            currentQuestionIndex = 0; score = 0; timeElapsed = 0;
            currentAttempt = { playerName: currentPlayerName, setName, startTime: new Date().toISOString(), answers: [], score: 0, totalQuestions: currentSet.length };
            document.getElementById('practiceArea').classList.remove('hidden');
            document.getElementById('practiceScore').textContent = 'Score: 0';
            timer = setInterval(() => { timeElapsed++; document.getElementById('practiceTimer').textContent = `Time: ${timeElapsed}s`; }, 1000);
            showNextQuestion();
        }
        
        function showNextQuestion() {
            if (currentQuestionIndex >= currentSet.length) { endPractice(); return; }
            const question = currentSet[currentQuestionIndex];
            document.getElementById('practiceQuestion').textContent = `${currentQuestionIndex + 1}. ${question.question}`;
            const optionsDiv = document.getElementById('practiceOptions');
            optionsDiv.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                optionDiv.onclick = () => selectAnswer(index);
                optionsDiv.appendChild(optionDiv);
            });
        }
        
        function selectAnswer(selectedIndex) {
            document.querySelectorAll('.option').forEach(o => { o.onclick = null; });
            const question = currentSet[currentQuestionIndex], correctIndex = question.correctAnswer.charCodeAt(0) - 65, isCorrect = selectedIndex === correctIndex;
            document.querySelectorAll('.option').forEach((o, i) => {
                if (i === correctIndex) o.classList.add('correct');
                else if (i === selectedIndex) o.classList.add('wrong');
            });

            // MODIFICATION: Store the question text and options to fix history retrieval
            currentAttempt.answers.push({ 
                isCorrect, 
                questionText: question.question,
                questionOptions: question.options,
                selectedAnswer: String.fromCharCode(65 + selectedIndex), 
                correctAnswer: question.correctAnswer 
            });

            if (isCorrect) { score++; playSound('correct'); addXP(XP_PER_CORRECT_ANSWER); document.getElementById('practiceScore').textContent = `Score: ${score}`; } 
            else { playSound('wrong'); }
            setTimeout(() => { currentQuestionIndex++; showNextQuestion(); }, 1500);
        }

        function endPractice() {
            clearInterval(timer);
            const percentage = currentSet.length > 0 ? Math.round((score / currentSet.length) * 100) : 0;
            currentAttempt = {...currentAttempt, endTime: new Date().toISOString(), score, percentage, timeSpent: timeElapsed};
            const attemptId = `attempt-${Date.now()}`;
            practiceHistory[attemptId] = currentAttempt;
            localStorage.setItem('pscPracticeHistory', JSON.stringify(practiceHistory));
            if (isFirebaseConnected) db.ref(`practiceHistory/${attemptId}`).set(currentAttempt);
            
            document.getElementById('modalTitle').textContent = percentage >= 80 ? "Excellent!" : (percentage >= 50 ? "Good Job!" : "Keep Trying!");
            document.getElementById('modalScore').textContent = `Score: ${score}/${currentSet.length} (${percentage}%)`;
            document.getElementById('modalTime').textContent = `Time: ${timeElapsed}s`;
            document.getElementById('modalXPGained').textContent = `You earned ${currentAttempt.answers.filter(a => a.isCorrect).length * XP_PER_CORRECT_ANSWER} XP!`;
            openModal('resultsModal');

            if (percentage >= 75) startConfetti();
            document.getElementById('practiceArea').classList.add('hidden');
        }

        function loadQuestionSets() {
            const setsList = document.getElementById('setsList');
            setsList.innerHTML = Object.keys(questionSets).map(setName => `
                <div class="question-set">
                    <h4>${setName} (${(questionSets[setName].questions || questionSets[setName]).length} questions)</h4>
                    <button onclick="deleteQuestionSet('${setName}')" class="btn-danger">Delete</button>
                </div>`).join('') || '<p>No question sets found.</p>';
        }

        function updateSetSelects() {
            const selects = [document.getElementById('practiceSetSelect'), document.getElementById('leaderboardSetFilter')];
            selects.forEach(s => {
                if (!s) return;
                const currentVal = s.value;
                s.innerHTML = (s.id === 'leaderboardSetFilter' ? '<option value="">All Sets</option>' : '<option value="">Select a question set</option>') +
                Object.keys(questionSets).map(name => `<option value="${name}">${name}</option>`).join('');
                s.value = currentVal;
            });
            const startBtn = document.getElementById('startPracticeBtn');
            if(startBtn) startBtn.disabled = Object.keys(questionSets).length === 0;
        }

        function updatePlayerSelects() {
            const selects = [document.getElementById('playerSelect'), document.getElementById('historyPlayerSelect')];
            const players = new Set(Object.values(practiceHistory).map(a => a.playerName));
            selects.forEach(s => {
                if (!s) return;
                const currentVal = s.value;
                s.innerHTML = `<option value="">Select a player</option>` +
                [...players].map(p => `<option value="${p}">${p}</option>`).join('');
                s.value = currentVal;
            });
        }
        
        function addQuestion() {
            const setName = document.getElementById('setName').value.trim();
            const qText = document.getElementById('questionText').value.trim();
            const optsText = document.getElementById('questionOptions').value.trim();
            if (!setName || !qText || !optsText) { showNotification('All fields are required.', 'error'); return; }
            const options = optsText.split('\n').map(o => o.trim()).filter(Boolean);
            if(options.length !== 4) { showNotification('Please provide exactly 4 options.', 'error'); return; }
            
            if(!questionSets[setName]) {
                questionSets[setName] = { questions: [], uploadDate: new Date().toISOString().split('T')[0] };
            }
            questionSets[setName].questions.push({ question: qText, options, correctAnswer: document.getElementById('correctAnswer').value });
            localStorage.setItem('pscQuestionSets', JSON.stringify(questionSets));
            if(isFirebaseConnected) db.ref('questionSets').set(questionSets);
            showNotification('Question added!');
            loadQuestionSets();
            updateSetSelects();
            document.getElementById('questionText').value = ''; document.getElementById('questionOptions').value = '';
        }

        function importBulkQuestions() {
            const setName = document.getElementById('bulkSetName').value.trim();
            const bulkText = document.getElementById('bulkQuestions').value.trim();
            if (!setName || !bulkText) { showNotification('Set name and questions are required for bulk import.', 'error'); return; }
            let imported = 0;
            
            if(!questionSets[setName]) {
                questionSets[setName] = { questions: [], uploadDate: new Date().toISOString().split('T')[0] };
            }
            bulkText.split('\n').forEach(line => {
                const parts = line.split('|').map(p => p.trim());
                if(parts.length === 6) {
                    questionSets[setName].questions.push({ question: parts[0], options: parts.slice(1, 5), correctAnswer: parts[5].toUpperCase() });
                    imported++;
                }
            });
            localStorage.setItem('pscQuestionSets', JSON.stringify(questionSets));
            if(isFirebaseConnected) db.ref('questionSets').set(questionSets);
            showNotification(`${imported} questions imported to ${setName}`);
            loadQuestionSets();
            updateSetSelects();
        }

        function deleteQuestionSet(setName) {
            showPasswordModal(`Delete "${setName}"?`, ADMIN_PASSWORD, () => {
                delete questionSets[setName];
                localStorage.setItem('pscQuestionSets', JSON.stringify(questionSets));
                if(isFirebaseConnected) db.ref(`questionSets/${setName}`).remove();
                showNotification(`Set "${setName}" deleted.`, 'error');
                loadQuestionSets();
                updateSetSelects();
            }, 'Enter Admin Password to Delete');
        }

        function showLeaderboard() {
            const filterSet = document.getElementById('leaderboardSetFilter').value;
            const attempts = Object.values(practiceHistory)
                .filter(a => !filterSet || a.setName === filterSet)
                .sort((a, b) => b.percentage - a.percentage || a.timeSpent - b.timeSpent);
            
            const tbody = document.getElementById('leaderboardTableBody');
            const timeFormat = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
            tbody.innerHTML = attempts.map((a, i) => `
                <tr class="${i === 0 ? 'winner' : ''}">
                    <td>${i + 1}</td>
                    <td>${a.playerName}</td>
                    <td>${a.setName}</td>
                    <td>${a.score}/${a.totalQuestions}</td>
                    <td>${a.percentage}%</td>
                    <td>${new Date(a.startTime).toLocaleString('en-US', timeFormat)}</td>
                </tr>`).join('') || '<tr><td colspan="6">No records found.</td></tr>';
        }

        function resetLeaderboard() {
            showPasswordModal("Reset all history?", ADMIN_PASSWORD, () => {
                practiceHistory = {};
                localStorage.setItem('pscPracticeHistory', JSON.stringify(practiceHistory));
                if(isFirebaseConnected) db.ref('practiceHistory').remove();
                showLeaderboard();
                showNotification('Leaderboard has been reset.', 'error');
            }, 'Enter Admin Password to Reset');
        }

        function loadHistory() {
            const playerName = document.getElementById('historyPlayerSelect').value;
            const listDiv = document.getElementById('historyList');
            if (!playerName) { listDiv.innerHTML = ''; return; }
            const attempts = Object.values(practiceHistory)
                .filter(a => a.playerName === playerName)
                .sort((a,b) => new Date(b.startTime) - new Date(a.startTime));
            
            const timeFormat = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
            listDiv.innerHTML = attempts.map(a => `
                <div class="history-item">
                    <h4>${a.setName} - ${new Date(a.startTime).toLocaleString('en-US', timeFormat)}</h4>
                    <p>Score: ${a.score}/${a.totalQuestions} (${a.percentage}%) | Time: ${a.timeSpent}s</p>
                    <button onclick="viewAttemptDetails('${a.startTime}')">View Details</button>
                </div>`).join('') || '<p>No history found for this player.</p>';
        }

        // MODIFICATION: Read question details directly from the history object (ans)
        function viewAttemptDetails(startTime) {
            const attempt = Object.values(practiceHistory).find(a => a.startTime === startTime);
            if (!attempt) return;
            
            let detailsHtml = `<h2>Details for ${attempt.setName}</h2>`;
            attempt.answers.forEach((ans, index) => { // Use 'index' for question number
                // Use the stored question and options (new fields from selectAnswer)
                const qText = ans.questionText || 'Question details missing (pre-fix attempt)';
                const qOptions = ans.questionOptions || ['A', 'B', 'C', 'D']; 

                const selectedIndex = ans.selectedAnswer.charCodeAt(0) - 65;
                const correctIndex = ans.correctAnswer.charCodeAt(0) - 65;
                const selectedText = qOptions[selectedIndex] || 'N/A';
                const correctText = qOptions[correctIndex] || 'N/A';

                detailsHtml += `
                    <div class="question-set" style="margin-top:15px;">
                        <p><strong>${index + 1}. ${qText}</strong></p>
                        <p class="${ans.isCorrect ? 'correct-answer' : 'wrong-answer'}">
                            Your Answer: ${ans.selectedAnswer}. ${selectedText}
                            ${ans.isCorrect ? '✓' : `✗ (Correct: ${ans.correctAnswer}. ${correctText})`}
                        </p>
                    </div>`;
            });
            document.getElementById('viewDetailsModalContent').innerHTML = detailsHtml + `<button onclick="closeModal('viewDetailsModal')" style="margin-top:20px;">Close</button>`;
            openModal('viewDetailsModal');
        }

        // --- REVISION FUNCTIONS ---
        function getDaysSince(dateString) {
            const today = new Date();
            const uploadDate = new Date(dateString);
            today.setHours(0, 0, 0, 0);
            uploadDate.setHours(0, 0, 0, 0);
            const diffTime = Math.abs(today - uploadDate);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function renderRevisionPage() {
            const revisionListDiv = document.getElementById('todaysRevisionList');
            revisionListDiv.innerHTML = '';
            const revisionIntervals = [0, 1, 3, 7, 14, 30, 60, 90];
            let setsDueToday = false;

            for (const setName in questionSets) {
                const set = questionSets[setName];
                if (!set || typeof set.uploadDate === 'undefined') continue;
                const daysSinceUpload = getDaysSince(set.uploadDate);
                
                if (revisionIntervals.includes(daysSinceUpload)) {
                    setsDueToday = true;
                    const setDiv = document.createElement('div');
                    setDiv.className = 'history-item';
                    setDiv.innerHTML = `
                        <h4>${setName}</h4>
                        <p>Due for Day ${daysSinceUpload} Revision (${set.questions.length} questions)</p>
                        <p><small>Uploaded on: ${new Date(set.uploadDate).toLocaleDateString()}</small></p>
                        <button onclick="startRevisionPractice('${setName}')">Start Revision</button>
                    `;
                    revisionListDiv.appendChild(setDiv);
                }
            }
            if (!setsDueToday) {
                revisionListDiv.innerHTML = '<p>No question sets are due for revision today. Great job staying on top of your studies!</p>';
            }
        }
        
        function startRevisionPractice(setName) {
            if (!questionSets[setName] || !currentPlayerName) {
                showNotification('Please select a player first from the Dashboard.', 'error');
                switchTab('practice');
                return;
            };
            document.getElementById('practiceSetSelect').value = setName;
            switchTab('practice');
            setTimeout(startPractice, 100);
        }
        
        // --- UI & UTILITY FUNCTIONS ---
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 8px; color: white; background: ${type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'}; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000; transform: translateX(120%); animation: slideInNotification 0.5s forwards;`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOutNotification 0.5s forwards';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        const style = document.createElement('style'); style.innerHTML = `@keyframes slideInNotification{to{transform:translateX(0)}}@keyframes slideOutNotification{from{transform:translateX(0)}to{transform:translateX(120%)}}`; document.head.appendChild(style);
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; document.getElementById('viewDetailsModalContent').innerHTML=''; }
        
        function showPasswordModal(prompt, correctPassword, onSuccess, title = "Admin Access") {
            document.getElementById('passwordModalTitle').textContent = title;
            document.getElementById('passwordModalPrompt').textContent = prompt;
            const input = document.getElementById('passwordInput');
            const submitBtn = document.getElementById('passwordSubmitBtn');
            input.value = '';
            openModal('passwordModal');
            submitBtn.onclick = () => {
                if (input.value === correctPassword) {
                    onSuccess(); closeModal('passwordModal');
                } else { showNotification('Incorrect Password', 'error'); }
            };
        }
        
        function playSound(type) {
             if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);
            if (type === 'correct') { oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(600, audioCtx.currentTime); oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1); } 
            else if (type === 'wrong') { oscillator.type = 'square'; oscillator.frequency.setValueAtTime(200, audioCtx.currentTime); oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); } 
            else if (type === 'levelup') { oscillator.type = 'triangle'; oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); oscillator.frequency.linearRampToValueAtTime(880, audioCtx.currentTime + 0.1); oscillator.frequency.linearRampToValueAtTime(660, audioCtx.currentTime + 0.2); }
            oscillator.start(audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2);
            oscillator.stop(audioCtx.currentTime + 0.2);
        }
        const confettiCanvas = document.getElementById('confetti-canvas'), confettiCtx = confettiCanvas.getContext('2d');
        let confettiParticles = [], animationFrameId;
        function startConfetti() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            confettiParticles = [];
            for (let i = 0; i < 150; i++) confettiParticles.push(createConfettiParticle());
            animateConfetti();
            setTimeout(stopConfetti, 4000);
        }
        function stopConfetti() { cancelAnimationFrame(animationFrameId); if(confettiCtx) confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height); }
        function createConfettiParticle() {
            const colors = ['#f1c40f', '#e74c3c', '#3498db', '#8e44ad', '#2ecc71'];
            return { x: Math.random() * confettiCanvas.width, y: -20, w: Math.random() * 10 + 5, h: Math.random() * 10 + 5, color: colors[Math.floor(Math.random() * colors.length)], vx: (Math.random() - 0.5) * 4, vy: Math.random() * 4 + 2, angle: Math.random() * Math.PI * 2, angularVelocity: (Math.random() - 0.5) * 0.1 };
        }
        function animateConfetti() {
            if(!confettiCtx) return;
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            confettiParticles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.angle += p.angularVelocity;
                if (p.y > confettiCanvas.height) confettiParticles.splice(i, 1);
                confettiCtx.save();
                confettiCtx.translate(p.x, p.y);
                confettiCtx.rotate(p.angle);
                confettiCtx.fillStyle = p.color;
                confettiCtx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                confettiCtx.restore();
            });
            if (confettiParticles.length > 0) animationFrameId = requestAnimationFrame(animateConfetti);
        }
    </script>
</body>
</html>